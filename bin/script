#!/usr/bin/env ruby --jit
require "bundler/setup"
require 'gossip'
puts "Ruby version: #{RUBY_VERSION}"

pipe = Gossip::Pipe.simple
protocol = Gossip::Protocol::SleepBased.new(pipe, ['root-1', 'root-2'])

# Protocol thread
Thread.new do
  protocol.run
end

#Â Output thread (stdout)
Thread.new do
  loop do
    message = pipe.q_out.pop
    puts "Message for #{message.to}: '#{message.type}'"
  end
end

# Input thread (stdin)
puts "Ready\n"
begin
  loop do
    input = gets
    break if input.nil?
    # TODO: Input
    ary = input.strip.split(' ')
    type = ary[1].gsub(/-/, "_").to_sym
    payload = { target_id: ary[2] } if type == :ping_req
    message = Gossip::Message::Inbound.new(ary[0], type, payload)

    pipe.q_in << message
  end
rescue Interrupt
end
puts "\nDone"
