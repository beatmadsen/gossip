#!/usr/bin/env ruby --jit
require "bundler/setup"
require 'gossip'
puts "Ruby version: #{RUBY_VERSION}"

pipe = Gossip::Pipe.simple
protocol = Gossip::Protocol::SleepBased.new(pipe)

# Protocol thread
Thread.new do
  protocol.run
end

#Â Output thread (stdout)
Thread.new do
  loop do
    receiver, message = pipe.q_out.pop
    puts "Message for #{receiver}: '#{message}'"
  end
end

# Input thread (stdin)
puts "Ready\n"
begin
  loop do
    input = gets
    break if input.nil?
    pipe.q_in << input.strip.split(',')
  end
rescue Interrupt
end
puts "\nDone"
